name: Build Windows package (onedir) and attach to Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Debug marker (always)
        shell: pwsh
        run: |
          "tag=${{ github.ref_name }}" | Out-File -Encoding utf8 ci_debug.txt
          git rev-parse HEAD | Out-File -Append -Encoding utf8 ci_debug.txt

      - name: Sanity check (no legacy project name)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          # legacy name(s) to forbid
          $patterns = @("kkr-query2sheet")

          $files = git ls-files
          $textFiles = $files |
            Where-Object { $_ -match '\.(md|txt|json|yml|yaml|sql|py|pyw|ps1|bat|cmd)$' } |
            Where-Object { $_ -ne ".github/workflows/release.yml" }

          $hits = $textFiles | ForEach-Object {
            Select-String -Path $_ -Pattern $patterns -SimpleMatch -ErrorAction SilentlyContinue
          }

          if ($hits) {
            Write-Host "Found legacy name occurrences (first 50):"
            $hits | Select-Object -First 50 | ForEach-Object {
              Write-Host ("- {0}:{1}: {2}" -f $_.Path, $_.LineNumber, $_.Line.Trim())
            }
            throw "Legacy project name found. Replace with 'kkr-query2xlsx'."
          }

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          python --version
          python -m pip install --upgrade pip
          if (Test-Path requirements.txt) { python -m pip install -r requirements.txt }
          python -m pip install pyinstaller pyodbc
          pip --version
          pip list

      - name: Build (PyInstaller - onedir)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $iconCandidates = @("docs\kkr-query2xlsx.ico","docs\icon.ico","docs\app.ico")
          $icon = $iconCandidates | Where-Object { Test-Path $_ } | Select-Object -First 1
          if ($icon) {
            pyinstaller --onedir --windowed --name kkr-query2xlsx --icon $icon --noupx --hidden-import pyodbc main.pyw
          } else {
            pyinstaller --onedir --windowed --name kkr-query2xlsx --noupx --hidden-import pyodbc main.pyw
          }

      - name: Build updater (PyInstaller - onefile)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          pyinstaller --onefile --windowed --name kkr-query2xlsx-updater --noupx updater.py

      - name: Debug (dist tree)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          if (Test-Path "dist") {
            Write-Host "dist tree:"
            Get-ChildItem -Path "dist" -Recurse | Select-Object FullName
          } else {
            Write-Host "dist does not exist"
          }

      - name: Package (portable bundle with examples + samples)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          # Clean bundle dir (defensive: avoids stale files when re-running locally)
          if (Test-Path "bundle") { Remove-Item -Recurse -Force "bundle" }

          $bundleRoot = "bundle\\kkr-query2xlsx"
          New-Item -ItemType Directory -Force -Path $bundleRoot | Out-Null

          # App binaries (PyInstaller onedir output)
          Copy-Item -Recurse -Force "dist\\kkr-query2xlsx\\*" $bundleRoot
          if (Test-Path "dist\\kkr-query2xlsx-updater.exe") {
            Copy-Item -Force "dist\\kkr-query2xlsx-updater.exe" $bundleRoot
          }

          # REQUIRED starter files (portable bundle contract)
          Copy-Item -Force "README.md" $bundleRoot
          Copy-Item -Force "secure.sample.json" $bundleRoot
          Copy-Item -Force "queries.sample.txt" $bundleRoot

          # LICENSE (if present in repo)
          if (Test-Path "LICENSE") { Copy-Item -Force "LICENSE" $bundleRoot }

          # REQUIRED: demo/examples + docs (README uses docs/logo.png)
          Copy-Item -Recurse -Force "examples" $bundleRoot
          Copy-Item -Recurse -Force "docs" $bundleRoot

          # Optional extras
          $optionalDirs = @("templates","queries")
          foreach ($d in $optionalDirs) {
            if (Test-Path $d) { Copy-Item -Recurse -Force $d $bundleRoot }
          }

          # Validate bundle structure (fail the release if something is missing)
          $required = @(
            "$bundleRoot\\kkr-query2xlsx.exe",
            "$bundleRoot\\secure.sample.json",
            "$bundleRoot\\queries.sample.txt",
            "$bundleRoot\\README.md",
            "$bundleRoot\\examples",
            "$bundleRoot\\docs"
          )
          $missing = $required | Where-Object { -not (Test-Path $_) }
          if ($missing) {
            Write-Error "Portable bundle is missing required paths:`n$($missing -join "`n")"
            exit 1
          }

          Compress-Archive -Path "bundle\\kkr-query2xlsx" -DestinationPath "kkr-query2xlsx-${{ github.ref_name }}-windows.zip"

      - name: Debug (bundle + zip presence)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Continue"
          if (Test-Path "bundle") {
            Write-Host "bundle tree:"
            Get-ChildItem -Path "bundle" -Recurse | Select-Object FullName
          }
          $zip = "kkr-query2xlsx-${{ github.ref_name }}-windows.zip"
          Write-Host "ZIP exists? " (Test-Path $zip)

      - name: Validate ZIP (portable bundle)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $zip = "kkr-query2xlsx-${{ github.ref_name }}-windows.zip"
          if (!(Test-Path $zip)) { throw "ZIP not found: $zip" }

          $tmp = "zip_check"
          if (Test-Path $tmp) { Remove-Item -Recurse -Force $tmp }
          Expand-Archive -Path $zip -DestinationPath $tmp

          $root = Join-Path $tmp "kkr-query2xlsx"
          if (!(Test-Path $root)) { throw "Expected folder 'kkr-query2xlsx/' inside ZIP." }

          # Required: onedir exe + runtime folder + samples + examples + README
          $requiredFiles = @(
            "kkr-query2xlsx.exe",
            "secure.sample.json",
            "queries.sample.txt",
            "README.md"
          )
          foreach ($f in $requiredFiles) {
            if (!(Test-Path (Join-Path $root $f))) { throw "Missing required file in ZIP: $f" }
          }

          $requiredDirs = @("_internal", "examples")
          foreach ($d in $requiredDirs) {
            if (!(Test-Path (Join-Path $root $d))) { throw "Missing required dir in ZIP: $d" }
          }

          # Include LICENSE if it exists in repo
          if (Test-Path "LICENSE") {
            if (!(Test-Path (Join-Path $root "LICENSE"))) {
              throw "LICENSE exists in repo, but is missing in ZIP."
            }
          }

          # Security: these must be created on first run, never shipped
          foreach ($f in @("secure.txt","queries.txt")) {
            if (Test-Path (Join-Path $root $f)) { throw "Forbidden file shipped in ZIP: $f" }
          }

          # Offline README logo: require docs/logo.png and README referencing it
          $logoPath = Join-Path $root "docs\\logo.png"
          if (!(Test-Path $logoPath)) { throw "Missing docs/logo.png in ZIP (offline README logo)." }

          $readme = Get-Content -Raw (Join-Path $root "README.md")
          if ($readme -notmatch 'docs/logo\.png') {
            throw "README.md does not reference docs/logo.png (offline logo would be broken)."
          }
          if ($readme -match '\.github/assets/logo\.png') {
            throw "README.md still references .github/assets/logo.png â€” change it to docs/logo.png for portable bundles."
          }

      - name: Upload artifacts (debug - always)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: windows-debug
          path: |
            ci_debug.txt
            dist/**
            bundle/**
            kkr-query2xlsx-*-windows.zip
          if-no-files-found: ignore

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: |
            kkr-query2xlsx-${{ github.ref_name }}-windows.zip
